- name: copy useful files
  copy:
    src: "{{ item }}"
    dest: "{{ item }}"
  loop:
    - profile.bash
    - mount-local-ssd.bash

- name: apply bash profile
  lineinfile:
    path: .bashrc
    regexp: "^source \\~/profile\\.bash"
    line: source ~/profile.bash

- file:
    path: ~/.ssh/config
    owner: sven
    group: sven
    state: touch

- name: install apt dependecies
  become: true
  apt:
    update_cache: yes
    pkg:
      - apt-transport-https
      - nethogs
      - htop
      - byobu
      - sysstat
      - less
      - jq
      - timelimit
      - rsync
    state: present

- stat:
    path: /cdnjs-sven
  register: local_ssd_dir
- name: mount local SSD
  become: true
  shell: bash mount-local-ssd.bash
  when: local_ssd_dir.stat.exists == False

- stat:
    path: /usr/local/git
  register: git_bin
- include: ./install-git.yml
  when: git_bin.stat.exists

- include: ./install-nodejs.yml

- name: configure git
  git_config:
    name: "{{ item.name }}"
    scope: global
    value: "{{ item.value }}"
  loop:
    - { name: core.preloadIndex, value: true }
    - { name: user.name, value: robocdnjs }
    - { name: user.email, value: cdnjs-github@cloudflare.com }
    - { name: core.editor, value: vim }
    - { name: credential.helper, value: cache }
    # Specifying 0 will cause Git to auto-detect the number of CPUâ€™s and
    # set the number of threads accordingly.
    - { name: pack.threads, value: 0 }
    # Maximum size in bytes of the buffer used by smart HTTP transports when
    # POSTing data to the remote system.
    # Default is 1M.
    - { name: http.postBuffer, value: 500M }
    # An integer -1..9, indicating a default compression level. -1 is the zlib
    # default. 0 means no compression, and 1..9 are various speed/size tradeoffs,
    # 9 being slowest.
    - { name: core.compression, value: 9 }

- name: create log files
  become: true
  file:
    path: "{{ item }}"
    owner: sven
    group: sven
    state: touch
  loop:
    - "{{ search_log_file }}"
    - "{{ website_log_file }}"
    - "{{ bot_log_file }}"
    - "{{ update_website_log_file }}"

- name: stop cdnjs-bot during the update
  ignore_errors: yes # service might not exist already
  become: true
  systemd:
    state: stopped
    name: cdnjs-bot

- include: ./github.yml
- include: ./install-cdnjs.yml
- include: ./systemd.yml
  tags:
      - systemd
- include: ./heroku.yml
  tags:
    - heroku
- include: ./website.yml
  tags:
    - website
- include: ./install-tools.yml
  tags:
    - tools
